import MTable from "../../components/MTable"
import Copyright from "../common/copyright.mdx";

# CircleCI Master Deploy Script

## Overview

  The Master Deploy Script is intended to standardize the deploy process from CircleCi to AWS. It specifically deals with three deployment scenarios:

  1. Deployments to Elastic Beanstalk
  2. Deployments to ECS
  3. Deployments to Cloudfront


  The script is designed with the following ideas in mind:

  - Use a single, centralized deployment script to standardize how deployments are done in each of the scenarios above
  - Avoid botched deployments that come from re-inventing the deploy process over and over
  - Capture improvements in the deploy process so that new deploy related feature, enhancements, efficiencies, ...etc are available to all our applications
  - Minimize the number of ENV variables that need to be input and maintained (we realize this is a trade-off)
  - Minimal reliance on CircleCI itself (the script and process is portable to another build platform)

  At a high level, a service will contain the tools needed to build itself - then it will clone the Master Deploy Script and use that for the deployment to AWS.

## How to use the Master Deploy Script

### Requirements for your code / application

  Please find the requirement for the code

  - The build package need to be generated as part of build
  - buildvar.conf and < APPNAME>-buildsecvar.conF need to be updated with proper environment variables

### How to use encrypted variables

  The secret environment variables are uploaded in file and encrypted in a file.Please find the below steps which will provide the details to encrypt and decrypt the  secret file

  1. The naming convention has followed for security variable files. The standard format is "< APPNAME>-buildsecvar.conf" .
    
    Consider the application name is direct, then the file name will be direct-buildsecvar.conf. The sample file content will be given below

    ```js
    DEV_AWS_ACCESS_KEY_ID="xyz"
    DEV_AWS_SECRET_ACCESS_KEY="abc"
    DEV_AWS_ACCOUNT_ID="1234"
    ```
  
  2. "< APPNAME>-buildsecvar.conf" has been encrypted using openssl aes-256-cbc algorithm  with specific key and the new file will be generated with name "< APPNAME>-buildsecvar.conf.enc".
    
    Here the direct-buildsecvar.conf.enc file will be generated by running below command

    ```js
    openssl enc -aes-256-cbc -salt -in direct-buildsecvar.conf -out direct-buildsecvar.conf.enc -k "<secretkey>"
    ```

  3. This encrypted file will be uploaded in GIT under specific application folder

  4. During build, the encrypted file will be copied to project folder and decrypted by running the openssl command with respective secret key. 

    The below command provide the decryption of direct-buildsecvar.conf.enc
    
    ```js
      openssl enc -aes-256-cbc -d -in direct-buildsecvar.conf.enc -out direct-buildsecvar.conf -k "<secretkey>"
    ```

  5. The secret key wil be set in SECPASSWD variiable on build environment
  

### Calling the Master Deploy Script

  ```js
    The Master Deploy Script accepts the following command line options:

    -h Show the help message
    -d Deployment Type [ECS|EBS|CFRONT]
    -e Environment [DEV|QA|PROD...]
    -t ECS Tag Name [mandatatory if ECS ]
    -v EBS version [mandatatory if EBS deployment]
    -c cache option true [optional : value = true| false]
    -s Security file location GIT|AWS
    -p ECS template type [CONTAINER|CONTAINERVOLUME|TDJSON]
  ```

### Minimum Build Variable configured for EBS|ECS|CFRONT

#### EBS

  ```js
    The below varaible need to be configured on buildvar.conf for DEV

    APPNAME="<Application Name>"
    SERVICE="<Serivice Name>"
    DOCKER_REGISTRY_NAME="<docker registry Name>"
    IMAGE_NAME="<docker image name>"
    DOCKERRUN="<File Name>"
    DEV_AWS_REGION="<AWS Region Name>"
    DEV_EBS_APPLICATION_NAME="<EBS Application Name>"
    DEV_AWS_EBS_ENV_NAME="<EBS environment Name>"
    DEV_AWS_S3_BUCKET="<EBS bucket>"
    DEV_AWS_S3_KEY_LOCATION="<key in S3>"
    DEV_AWS_EBS_EB_DOCKERRUN_TEMPLATE_LOCATION="<DOCKER RUN Template Location>"
    DEV_AWS_EBS_DOCKERRUN_TEMPLATE="<Dockerrun template Name>"
  ```

  ```js
    Example:

    APPNAME="identity"
    SERVICE="identity"
    DOCKER_REGISTRY_NAME="appiriodevops"
    IMAGE_NAME="ap-${SERVICE}-microservice"
    DOCKERRUN="Dockerrun.aws.json"
    DEV_AWS_REGION=us-east-1
    DEV_EBS_APPLICATION_NAME="Development"
    DEV_AWS_EBS_ENV_NAME="ap-${SERVICE}-dev"
    DEV_AWS_S3_BUCKET="appirio-platform-dev"
    DEV_AWS_S3_KEY_LOCATION="services/docker"
    DEV_AWS_EBS_EB_DOCKERRUN_TEMPLATE_LOCATION="$HOME/project/tech.core/tech.core.service.identity/build/eb"
    DEV_AWS_EBS_DOCKERRUN_TEMPLATE="Dockerrun.aws.json.template"
  ```

  ```js
    The below variable need to be configured on <APPNAME>-buildsecvar.conf

    DEV_AWS_ACCESS_KEY_ID="xyz"
    DEV_AWS_SECRET_ACCESS_KEY="abc"
    DEV_AWS_ACCOUNT_ID="1234"
  ```

#### ECS

  ```js
    The below varaible need to be configured on buildvar.conf for DEV
    
    APPNAME="<Application Name>"
    DEV_AWS_REGION="<AWS region>"
    DEV_AWS_REPOSITORY="<AWS ECR Name>"
    DEV_AWS_ECS_CLUSTER="<AWS ECS Cluster Name>"
    DEV_AWS_ECS_SERVICE="<AWS ECS Service Name>"
    DEV_AWS_ECS_TASK_FAMILY="<AWS ECS Task Name>"
    DEV_AWS_ECS_CONTAINER_NAME="<AWS ECS container Name>"
    DEV_AWS_ECS_TEMPLATE_UPDATE_SCRIPT="<taskdef template update script>"
    DEV_AWS_ECS_TASKDEF_FILE="<AWS task definition file>"
    DEV_AWS_ECS_VOLUMEDEF_FILE="<optional: If volume definition file exist>"
  ```

  ```js
    Example

    APPNAME="email-service"
    DEV_AWS_REGION="us-east-1"
    DEV_AWS_REPOSITORY="tc-email-service"
    DEV_AWS_ECS_CLUSTER="tc-email-service"
    DEV_AWS_ECS_SERVICE="tc-email-service-svc"
    DEV_AWS_ECS_TASK_FAMILY="tc-email-service-task"
    DEV_AWS_ECS_CONTAINER_NAME="tc-email-service-container"
    DEV_AWS_ECS_TEMPLATE_UPDATE_SCRIPT="templateupdate.sh"
    DEV_AWS_ECS_TASKDEF_FILE="taskdef.json"
    DEV_AWS_ECS_VOLUMEDEF_FILE=""
  ```

  ```js
    The below variable need to be configured on <APPNAME>-buildsecvar.conf

    DEV_AWS_ACCESS_KEY_ID="xyz"
    DEV_AWS_SECRET_ACCESS_KEY="abc"
    DEV_AWS_ACCOUNT_ID="1234"
  ```

#### CFRONT:

  ```js
    The below variable need to be configured on buildvar.conf for DEV

    APPNAME="<Application Name>"
    DEV_AWS_REGION="<AWS region>"
    DEV_AWS_S3_BUCKET="<Bucket Name>"
    DEV_SOURCE_SYNC_PATH=".<Source Path Need to be sync>"
  ```

  ```js
    Example:

    APPNAME="connect"
    DEV_AWS_REGION=us-east-1
    DEV_AWS_S3_BUCKET="connect-auth0.topcoder-dev.com"
    DEV_SOURCE_SYNC_PATH="./workspace/dist
  ```

  ```js
    The below variable need to be configured on <APPNAME>-buildsecvar.conf

    DEV_AWS_ACCESS_KEY_ID="xyz"
    DEV_AWS_SECRET_ACCESS_KEY="abc"
    DEV_AWS_ACCOUNT_ID="1234"
  ```

  Example of calling the Master Deploy Script for an Elastic Beanstalk deployment

  ```js
    ./master_deploy.sh -d EBS -e DEV -v ${VER} -s GIT
  ```

  Example of calling the Master Deploy Script for an ECS deployment

  ```js
    ./master_deploy.sh -d ECS -e DEV -t $CIRCLE_SHA1 -s GIT -p TDJSON
  ```

  Example of calling the Master Deploy Script for a Cloudfront deployment

  ```js
    ./master_deploy.sh -d CFRONT -e DEV -s GIT
  ```

<Copyright />
